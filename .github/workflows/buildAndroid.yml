name: Build Android App

on:
  workflow_dispatch:
  # push:
  #   branches:
  #     - main  

jobs:
  build:
    runs-on: ubuntu-latest
    permissions:
      contents: write  # タグを作成・プッシュするために必要
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          fetch-depth: 0  # 全履歴を取得してタグを確認するため
          
      - name: Manage version tag
        id: version_tag
        uses: ./.github/actions/manage-version-tag
      
      - name: Calculate version string for pubspec
        id: version_string
        run: |
          BUILD_VERSION="${{ steps.version_tag.outputs.build_version }}"
          
          # バージョン番号を抽出(v1.2.3形式から1.2.3を取得)
          VERSION_NUM=${BUILD_VERSION#v}
          IFS='.' read -r MAJOR MINOR PATCH <<< "$VERSION_NUM"
          
          # pubspec.yamlのバージョン形式に合わせる(1.2.3+123形式)
          # versionCodeは常に増加する必要があるため、MAJOR*1000000 + MINOR*1000 + PATCH で計算
          # 各セグメントは3桁(0-999)まで対応
          # 例: v1.0.1 → 1.0.1+1000001, v1.0.2 → 1.0.2+1000002, v1.1.0 → 1.1.0+1001000
          # +以降がGoogle Play Storeのバージョンコードとして使用されるらしい。この番号は増加し続けなきゃいけないらしい。
          BUILD_NUMBER=$((MAJOR * 1000000 + MINOR * 1000 + PATCH))
          VERSION_STRING="${MAJOR}.${MINOR}.${PATCH}+${BUILD_NUMBER}"
          
          echo "version_string=$VERSION_STRING" >> $GITHUB_OUTPUT
          echo "Version string for pubspec: $VERSION_STRING"
      
      - name: Update pubspec.yaml version
        run: |
          VERSION_STRING="${{ steps.version_string.outputs.version_string }}"
          # pubspec.yamlのバージョンを更新
          sed -i "s/^version:.*/version: $VERSION_STRING/" pubspec.yaml
          echo "Updated pubspec.yaml version to: $VERSION_STRING"
          cat pubspec.yaml | grep "^version:"
          
      - name: Setup Flutter
        uses: ./.github/actions/setup-flutter
        with:
          flutter-version: '3.29.2'
          google-service-json: ${{ secrets.GOOGLE_SERVICES_JSON }}
          env-file-content: ${{ secrets.ENV_FILE }}
      
      - name: Build the app
        run: flutter build apk --release

      - name: Upload the app
        uses: actions/upload-artifact@v4
        with:
          name: app-release-${{ steps.version_tag.outputs.build_version }}.apk
          path: build/app/outputs/flutter-apk/app-release.apk
          retention-days: 1
