name: 'Manage Version Tag'
description: 'Calculate version from latest tag and create new tag if there are changes'

outputs:
  latest_tag:
    description: 'Latest tag found (empty if none)'
    value: ${{ steps.version.outputs.latest_tag }}
  new_version:
    description: 'New version to be created'
    value: ${{ steps.version.outputs.new_version }}
  major:
    description: 'Major version number'
    value: ${{ steps.version.outputs.major }}
  minor:
    description: 'Minor version number'
    value: ${{ steps.version.outputs.minor }}
  patch:
    description: 'Patch version number'
    value: ${{ steps.version.outputs.patch }}
  has_changes:
    description: 'Whether there are changes since last tag'
    value: ${{ steps.changes.outputs.has_changes }}
  build_version:
    description: 'Version to use for build'
    value: ${{ steps.build_version.outputs.build_version }}

runs:
  using: 'composite'
  steps:
    - name: Get latest tag and calculate version
      id: version
      shell: bash
      run: |
        # 最新のタグを取得(vで始まるタグのみ)
        LATEST_TAG=$(git describe --tags --match "v*" --abbrev=0 2>/dev/null || echo "")
        
        if [ -z "$LATEST_TAG" ]; then
          # タグが存在しない場合はv1.0.0から開始
          NEW_VERSION="v1.0.0"
          MAJOR=1
          MINOR=0
          PATCH=0
        else
          # タグからバージョン番号を抽出(v1.2.3形式を想定）
          VERSION_NUM=${LATEST_TAG#v}
          IFS='.' read -r MAJOR MINOR PATCH <<< "$VERSION_NUM"
          
          # パッチバージョンをインクリメント
          PATCH=$((PATCH + 1))
          NEW_VERSION="v${MAJOR}.${MINOR}.${PATCH}"
        fi
        
        echo "latest_tag=$LATEST_TAG" >> $GITHUB_OUTPUT
        echo "new_version=$NEW_VERSION" >> $GITHUB_OUTPUT
        echo "major=$MAJOR" >> $GITHUB_OUTPUT
        echo "minor=$MINOR" >> $GITHUB_OUTPUT
        echo "patch=$PATCH" >> $GITHUB_OUTPUT
        
        echo "Latest tag: $LATEST_TAG"
        echo "New version: $NEW_VERSION"
    
    - name: Check if there are changes since last tag
      id: changes
      shell: bash
      run: |
        LATEST_TAG="${{ steps.version.outputs.latest_tag }}"
        
        if [ -z "$LATEST_TAG" ]; then
          # タグが存在しない場合は変更ありとみなす
          echo "has_changes=true" >> $GITHUB_OUTPUT
          echo "No previous tag found, building new version"
        else
          # 前回のタグから変更があるかチェック
          if git diff --quiet $LATEST_TAG HEAD; then
            echo "has_changes=false" >> $GITHUB_OUTPUT
            echo "No changes since $LATEST_TAG, will use existing tag version"
          else
            echo "has_changes=true" >> $GITHUB_OUTPUT
            echo "Changes detected since $LATEST_TAG, building new version"
          fi
        fi
    
    - name: Determine build version
      id: build_version
      shell: bash
      run: |
        if [ "${{ steps.changes.outputs.has_changes }}" == "true" ]; then
          BUILD_VERSION="${{ steps.version.outputs.new_version }}"
        else
          BUILD_VERSION="${{ steps.version.outputs.latest_tag }}"
        fi
        
        echo "build_version=$BUILD_VERSION" >> $GITHUB_OUTPUT
        echo "Building with version: $BUILD_VERSION"
    
    - name: Create git tag (if new version)
      if: steps.changes.outputs.has_changes == 'true'
      shell: bash
      run: |
        NEW_VERSION="${{ steps.version.outputs.new_version }}"
        git config user.name "github-actions[bot]"
        git config user.email "github-actions[bot]@users.noreply.github.com"
        git tag -a "$NEW_VERSION" -m "Release $NEW_VERSION"
        git push origin "$NEW_VERSION"

